<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders | Matie Cake</title>
    <link rel="icon" type="image/png" href="Image/Logo.png">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #12132f;
            --accent: #d99c2b;
            --muted: #666;
            --bg: #f6f5f2;
            --card: #ffffff;
            --border: #e4dfd8;
            --shadow: 0 14px 36px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--bg);
            color: #222;
        }

        header {
            background: linear-gradient(90deg, #1a1157, #3f53ae);
            color: #fff;
            padding: 0 36px;
            height: 83px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.16);
        }

        .logo {
            height: 60px;
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .page-header h1 {
            margin: 0 0 8px;
            color: var(--primary);
            font-size: 2rem;
        }

        .page-header p {
            color: var(--muted);
            font-size: 1rem;
        }

        .order-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .order-id-large {
            font-weight: 700;
            color: var(--accent);
            font-size: 1.2rem;
        }

        .order-date {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .order-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .order-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .order-info-label {
            color: var(--muted);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .order-info-value {
            color: var(--primary);
            font-weight: 600;
            font-size: 1rem;
        }

        .order-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
            text-decoration: none;
            display: inline-block;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(180deg, #ffe066, #ffd633);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h2 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        .copy-btn {
            padding: 6px 12px;
            background: var(--accent);
            color: var(--primary);
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .copy-btn:hover {
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: #10b981;
            color: white;
        }

        .order-details {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .order-details.show {
            display: block;
        }

        .toggle-details-btn {
            background: transparent;
            color: var(--accent);
            border: none;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 0;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
            width: 100%;
        }

        .toggle-details-btn:hover {
            color: var(--primary);
        }

        .toggle-details-btn span {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-details-btn span::after {
            content: '‚ñº';
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .toggle-details-btn.expanded span::after {
            transform: rotate(180deg);
        }

        .details-section {
            margin-bottom: 24px;
        }

        .details-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent);
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .order-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }

        .item-details {
            font-size: 0.9rem;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .item-price {
            font-weight: 600;
            color: var(--accent);
            font-size: 1rem;
            margin-top: auto;
        }

        .shipment-group {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .shipment-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .shipment-address {
            color: var(--muted);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .shipment-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 16px;
        }

        .shipment-item-name {
            font-size: 0.9rem;
            color: var(--primary);
        }

        .payment-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .contact-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .gift-message {
            padding: 12px;
            background: #fff9e6;
            border-left: 4px solid var(--accent);
            border-radius: 4px;
            font-style: italic;
            color: var(--primary);
            margin-top: 8px;
        }

        .addon-list {
            margin-top: 8px;
            padding-left: 16px;
        }

        .addon-item {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <header>
        <a href="index.html"><img src="Image/Logo.png" alt="Matie Cake" class="logo"></a>
    </header>

    <div class="container">
        <div class="page-header">
            <h1>My Orders</h1>
            <p>View and track all your orders</p>
        </div>

        <div id="orders-container"></div>
    </div>

    <script>
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Convert order items to shipments (group by address)
        function getShipmentsFromOrder(order) {
            if (!order || !order.items || !Array.isArray(order.items)) {
                return [];
            }

            const shipmentsMap = {};

            order.items.forEach((item) => {
                const address = item.shippingAddress || {};
                const addressKey = item.shippingAddressId || JSON.stringify({
                    name: address.name || '',
                    street: address.street || '',
                    city: address.city || '',
                    phone: address.phone || ''
                });

                if (!shipmentsMap[addressKey]) {
                    shipmentsMap[addressKey] = {
                        id: `#SHIP-${Object.keys(shipmentsMap).length + 1}`,
                        recipient: [
                            address.name,
                            address.street,
                            address.city,
                            address.state,
                            address.zip,
                            address.phone
                        ].filter(Boolean).join(', ') || 'No address',
                        items: []
                    };
                }

                shipmentsMap[addressKey].items.push(item);
            });

            return Object.values(shipmentsMap);
        }

        // Format payment method name
        function formatPaymentMethod(method) {
            const methods = {
                'card': 'Credit/Debit Card',
                'paypal': 'PayPal',
                'momo': 'MoMo',
                'vnpay': 'VNPay',
                'cod': 'Cash on Delivery'
            };
            return methods[method] || method || 'N/A';
        }

        // Render order items list
        function renderOrderItems(items) {
            if (!items || items.length === 0) return '<p>No items found.</p>';

            return items.map(item => {
                const image = item.productImage || item.boxThumb || 'Image/Logo.png';
                const name = item.productName || 'Unknown Product';
                const quantity = item.quantity || 1;
                const price = item.finalPrice || 0;
                const totalPrice = price * quantity;

                // Build addons/options list
                let addonsHtml = '';
                if (item.selectedOptions && item.selectedOptions.length > 0) {
                    addonsHtml = '<div class="addon-list">';
                    item.selectedOptions.forEach(opt => {
                        const optQty = opt.quantity || 1;
                        addonsHtml += `<div class="addon-item">+ ${opt.name}${optQty > 1 ? ` (x${optQty})` : ''} - $${(opt.price || 0).toFixed(2)}</div>`;
                    });
                    addonsHtml += '</div>';
                }

                // Gift message
                let giftMessageHtml = '';
                if (item.giftMessage && item.giftMessage.trim()) {
                    giftMessageHtml = `<div class="gift-message">"${item.giftMessage}"</div>`;
                }

                // Recipient info
                let recipientInfo = '';
                if (item.recipientRelationship || item.recipientOccasion) {
                    const parts = [];
                    if (item.recipientRelationship) parts.push(item.recipientRelationship);
                    if (item.recipientOccasion) parts.push(item.recipientOccasion);
                    if (parts.length > 0) {
                        recipientInfo = `<div class="item-details">For: ${parts.join(' - ')}</div>`;
                    }
                }

                return `
                    <div class="order-item">
                        <img src="${image}" alt="${name}" class="item-image" onerror="this.src='Image/Logo.png'">
                        <div class="item-info">
                            <div class="item-name">${name}</div>
                            <div class="item-details">
                                Quantity: ${quantity}
                                ${addonsHtml}
                                ${recipientInfo}
                                ${giftMessageHtml}
                            </div>
                            <div class="item-price">$${totalPrice.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render shipments with addresses
        function renderShipments(shipments) {
            if (!shipments || shipments.length === 0) return '<p>No shipment information available.</p>';

            return shipments.map((shipment, idx) => {
                const itemsList = shipment.items.map(item => {
                    const name = item.productName || 'Unknown Product';
                    const quantity = item.quantity || 1;
                    return `<div class="shipment-item-name">${name} (x${quantity})</div>`;
                }).join('');

                return `
                    <div class="shipment-group">
                        <div class="shipment-header">Shipment ${idx + 1} - ${shipment.id}</div>
                        <div class="shipment-address">${shipment.recipient}</div>
                        <div class="shipment-items">${itemsList}</div>
                    </div>
                `;
            }).join('');
        }

        // Render payment information
        function renderPaymentInfo(checkout) {
            if (!checkout) return '<p>No payment information available.</p>';

            const paymentMethod = formatPaymentMethod(checkout.paymentMethod);
            let paymentDetails = '';

            if (checkout.paymentMethod === 'card' && checkout.card) {
                const cardNumber = checkout.card.number || '';
                const maskedCard = cardNumber.length > 4 ? '****' + cardNumber.slice(-4) : 'N/A';
                paymentDetails = `<div class="order-info-value">Card ending in ${maskedCard}</div>`;
            } else if (checkout.paymentMethod === 'momo' && checkout.momo) {
                paymentDetails = `<div class="order-info-value">Phone: ${checkout.momo.phone || 'N/A'}</div>`;
            } else if (checkout.paymentMethod === 'vnpay' && checkout.vnpay) {
                paymentDetails = `<div class="order-info-value">Bank: ${checkout.vnpay.bank || 'N/A'}</div>`;
            }

            return `
                <div class="payment-info">
                    <div class="order-info-item">
                        <span class="order-info-label">Payment Method</span>
                        <span class="order-info-value">${paymentMethod}</span>
                        ${paymentDetails}
                    </div>
                </div>
            `;
        }

        // Render contact information
        function renderContactInfo(checkout) {
            if (!checkout || !checkout.contact) return '<p>No contact information available.</p>';

            const contact = checkout.contact;
            return `
                <div class="contact-info">
                    <div class="order-info-item">
                        <span class="order-info-label">Email</span>
                        <span class="order-info-value">${contact.email || 'N/A'}</span>
                    </div>
                    <div class="order-info-item">
                        <span class="order-info-label">Phone</span>
                        <span class="order-info-value">${contact.phone || 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        // Display all orders
        function displayAllOrders() {
            try {
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const ordersContainer = document.getElementById('orders-container');

                if (!ordersContainer) return;

                if (orders.length === 0) {
                    ordersContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <h2>No Orders Yet</h2>
                            <p>You haven't placed any orders yet.</p>
                            <a href="index.html" class="btn btn-primary" style="margin-top: 20px;">Start Shopping</a>
                        </div>
                    `;
                    return;
                }

                // Sort orders by date (newest first)
                const sortedOrders = [...orders].sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA;
                });

                ordersContainer.innerHTML = sortedOrders.map((order, orderIdx) => {
                    const phone = order.checkout?.contact?.phone || 'N/A';
                    const total = order.total || 0;
                    const itemCount = order.items ? order.items.reduce((sum, item) => sum + (item.quantity || 1), 0) : 0;
                    const shipments = getShipmentsFromOrder(order);
                    const shipmentCount = shipments.length;

                    return `
                        <div class="order-card">
                            <div class="order-card-header">
                                <span class="order-id-large">${order.id}</span>
                                <span class="order-date">${formatDate(order.date)}</span>
                            </div>
                            <div class="order-info-grid">
                                <div class="order-info-item">
                                    <span class="order-info-label">Phone Number</span>
                                    <span class="order-info-value">${phone}</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="order-info-label">Items</span>
                                    <span class="order-info-value">${itemCount} ${itemCount === 1 ? 'item' : 'items'}</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="order-info-label">Shipments</span>
                                    <span class="order-info-value">${shipmentCount} ${shipmentCount === 1 ? 'shipment' : 'shipments'}</span>
                                </div>
                                <div class="order-info-item">
                                    <span class="order-info-label">Total</span>
                                    <span class="order-info-value">$${total.toFixed(2)}</span>
                                </div>
                            </div>
                            <button class="toggle-details-btn" data-order-index="${orderIdx}">
                                <span>View Order Details</span>
                            </button>
                            <div class="order-details" id="order-details-${orderIdx}">
                                <div class="details-section">
                                    <div class="details-section-title">Order Items</div>
                                    <div class="items-list">
                                        ${renderOrderItems(order.items)}
                                    </div>
                                </div>
                                <div class="details-section">
                                    <div class="details-section-title">Shipping Addresses</div>
                                    ${renderShipments(shipments)}
                                </div>
                                <div class="details-section">
                                    <div class="details-section-title">Payment Information</div>
                                    ${renderPaymentInfo(order.checkout)}
                                </div>
                                <div class="details-section">
                                    <div class="details-section-title">Contact Information</div>
                                    ${renderContactInfo(order.checkout)}
                                </div>
                            </div>
                            <div class="order-actions">
                                <a href="tracking.html?orderId=${encodeURIComponent(order.id)}&phone=${encodeURIComponent(phone)}" 
                                   class="btn btn-primary">Track Order</a>
                                <button class="btn btn-outline copy-order-btn" 
                                        data-order-id="${order.id}">Copy Order ID</button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach copy button handlers
                ordersContainer.querySelectorAll('.copy-order-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const orderId = this.dataset.orderId;
                        copyToClipboard(orderId, this);
                    });
                });

                // Attach toggle details button handlers
                ordersContainer.querySelectorAll('.toggle-details-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const orderIndex = this.dataset.orderIndex;
                        const detailsDiv = document.getElementById(`order-details-${orderIndex}`);
                        const span = this.querySelector('span');
                        if (detailsDiv && span) {
                            const isExpanded = detailsDiv.classList.contains('show');
                            if (isExpanded) {
                                detailsDiv.classList.remove('show');
                                this.classList.remove('expanded');
                                span.textContent = 'View Order Details';
                            } else {
                                detailsDiv.classList.add('show');
                                this.classList.add('expanded');
                                span.textContent = 'Hide Order Details';
                            }
                        }
                    });
                });
            } catch (e) {
                console.error('Error displaying orders:', e);
                document.getElementById('orders-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <h2>Error Loading Orders</h2>
                        <p>There was an error loading your orders. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Copy to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please copy manually: ' + text);
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', displayAllOrders);
    </script>
</body>

</html>